---
title: Custom HMR Client
---

Rollipop allows you to send custom messages from the development server to your React Native application via WebSocket. This is useful for implementing custom features like remote control, live updates, or debugging tools during development.

<Callout type="warn">
This feature only works in development mode.
</Callout>

## Sending Messages from Server

Use the `configureServer` hook in a plugin to access the HMR WebSocket server:

```ts title="my-plugin.ts"
import type { Plugin } from 'rollipop';

export function myPlugin(): Plugin {
  return {
    name: 'my-plugin',
    configureServer(server) {
      // Send a message to all connected clients
      server.hot.sendAll(JSON.stringify({
        type: 'my-custom-event',
        payload: { message: 'Hello from server!' }
      }));

      // Example: Send periodic updates
      let count = 0;
      setInterval(() => {
        server.hot.sendAll(JSON.stringify({
          type: 'counter-update',
          payload: { count: count++ }
        }));
      }, 5000);
    },
  };
}
```

### API Reference

`server.hot.sendAll(data: string | Buffer)`

Broadcasts a message to all connected HMR clients.

**Parameters:**
- `data`: The message to send. Must be a string (typically JSON-serialized) or Buffer.

**Example:**
```ts
server.hot.sendAll(JSON.stringify({
  type: 'my-event',
  payload: { foo: 'bar' }
}));
```

`server.hot.send(client: WebSocket, data: string | Buffer)`

Sends a message to a specific client.

**Parameters:**
- `client`: The WebSocket client instance
- `data`: The message to send

## Receiving Messages on Client

In your React Native application, register a custom HMR handler to receive messages:

```tsx title="App.tsx"
import { useEffect } from 'react';
import { setCustomHMRHandler } from 'rollipop/runtime';
import type { HMRCustomServerMessage } from 'rollipop/runtime';

export default function App() {
  useEffect(() => {
    if (__DEV__) {
      setCustomHMRHandler((message: HMRCustomServerMessage) => {
        console.log('Received custom HMR message:', message);

        // Handle different message types
        switch (message.type) {
          case 'my-custom-event':
            console.log('Payload:', message.payload);
            break;

          case 'counter-update':
            console.log('Counter:', message.payload.count);
            break;
        }
      });
    }
  }, []);

  return (
    // Your app component
  );
}
```

### API Reference

`setCustomHMRHandler(handler: HMRCustomHandler)`

Registers a handler function to receive custom HMR messages from the server.

**Parameters:**
- `handler`: A callback function that receives `HMRCustomServerMessage` objects

**Types:**
```ts
type HMRCustomHandler = (message: HMRCustomServerMessage) => void;

type HMRCustomServerMessage = {
  type: string;
  payload: unknown;
};
```

<Callout type="warn">
**Important**: Only one custom HMR handler can be registered at a time. Calling `setCustomHMRHandler()` again will replace the existing handler.
</Callout>

## Complete Example

Here's a complete example of a plugin that sends custom messages and a React Native app that receives them:

### Plugin

```ts title="rollipop-plugin-remote-control.ts"
import type { Plugin } from 'rollipop';

interface RemoteControlMessage {
  type: 'remote:toggle-debug' | 'remote:show-alert';
  payload?: any;
}

export function remoteControlPlugin(): Plugin {
  return {
    name: 'remote-control-plugin',
    configureServer(server) {
      // Access the Fastify instance to add a custom route
      server.instance.post('/api/remote-control', async (request, reply) => {
        const message = request.body as RemoteControlMessage;

        // Broadcast to all connected clients
        server.hot.sendAll(JSON.stringify(message));

        return { success: true };
      });

      console.log('Remote control plugin ready!');
      console.log('Send commands via: POST http://localhost:8081/api/remote-control');
    },
  };
}
```

### Configuration

```ts title="rollipop.config.ts"
import { defineConfig } from 'rollipop';
import { remoteControlPlugin } from './rollipop-plugin-remote-control';

export default defineConfig({
  plugins: [remoteControlPlugin()],
});
```

### React Native App

```tsx title="App.tsx"
import { useEffect, useState } from 'react';
import { Alert, View, Text } from 'react-native';
import { setCustomHMRHandler } from 'rollipop/runtime';
import type { HMRCustomServerMessage } from 'rollipop/runtime';

export default function App() {
  const [debugMode, setDebugMode] = useState(false);

  useEffect(() => {
    if (__DEV__) {
      setCustomHMRHandler((message: HMRCustomServerMessage) => {
        switch (message.type) {
          case 'remote:toggle-debug':
            setDebugMode((prev) => !prev);
            break;

          case 'remote:show-alert':
            Alert.alert(
              message.payload?.title || 'Alert',
              message.payload?.message || 'No message'
            );
            break;
        }
      });
    }
  }, []);

  return (
    <View>
      <Text>Debug Mode: {debugMode ? 'ON' : 'OFF'}</Text>
    </View>
  );
}
```

### Triggering Remote Commands

```bash
# Toggle debug mode
curl -X POST http://localhost:8081/api/remote-control \
  -H "Content-Type: application/json" \
  -d '{"type":"remote:toggle-debug"}'

# Show alert
curl -X POST http://localhost:8081/api/remote-control \
  -H "Content-Type: application/json" \
  -d '{"type":"remote:show-alert","payload":{"title":"Hello","message":"From server!"}}'
```

## Use Cases

Custom HMR messaging can be used for:

- **Remote debugging**: Send commands to toggle debug features
- **Live configuration**: Update app settings without rebuilding
- **Testing tools**: Trigger specific app states or scenarios
- **Development utilities**: Custom tooling integrated with your dev server
- **Real-time notifications**: Push updates to developers during development
